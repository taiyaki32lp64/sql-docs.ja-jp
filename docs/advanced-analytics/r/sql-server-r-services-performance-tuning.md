---
title: R のパフォーマンス チューニング
description: この記事では、R Services のパフォーマンスの最適化について説明します。
ms.prod: sql
ms.technology: machine-learning
ms.date: 04/15/2018
ms.topic: conceptual
author: dphansen
ms.author: davidph
ms.custom: seo-lt-2019
monikerRange: '>=sql-server-2016||>=sql-server-linux-ver15||=sqlallproducts-allversions'
ms.openlocfilehash: 4d7b6b91ac3aeaa45c5e6c3e05c12176f5f60b28
ms.sourcegitcommit: 09ccd103bcad7312ef7c2471d50efd85615b59e8
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/07/2019
ms.locfileid: "73727359"
---
# <a name="performance-tuning-for-r-in-sql-server"></a>SQL Server での R のパフォーマンス チューニング
[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md](../../includes/appliesto-ss-xxxx-xxxx-xxx-md.md)]

この記事は、次の 2 つのケース スタディに基づいて、R Services のパフォーマンスの最適化について説明するシリーズの、4 つの記事のうちの最初の記事です。

- R ソリューションのパフォーマンス プロファイルを検証するために、製品開発チームによって実行されるパフォーマンス テスト

- 顧客から頻繁に要求される特定の機械学習シナリオに対する、Microsoft データ サイエンス チームによるパフォーマンスの最適化。

このシリーズの目的は、SQL Server で R のジョブを実行する際に最も役立つ、各種のパフォーマンス チューニング手法に関してのガイダンスを提供することです。

+ この (最初の) トピックでは、アーキテクチャの概要と、データ サイエンス タスクのための最適化の際の一般的な問題について説明します。
+ 2 番目の記事では、特定のハードウェアと SQL Server の最適化について説明します。
+ 3 番目の記事では、R コードの最適化と運用化のためのリソースについて説明します。
+ 4 番目の記事では、テストの方法について詳しく説明し、結果と結論を報告します。

**適用対象:** SQL Server 2016 R Services、SQL Server Machine Learning Services

## <a name="performance-goals-and-targeted-scenarios"></a>パフォーマンス目標および対象となるシナリオ

R Services 機能は、SQL Server での R スクリプトの実行をサポートするために、SQL Server 2016 で導入されました。 この機能を使用すると、R ランタイムはデータベース エンジンとは別のプロセスで動作しますが、Trusted Launchpad などの SQL Server と対話するサーバー リソースやサービスを使用して、データを安全にデータベース エンジンと交換します。

SQL Server 2017 では、同じアーキテクチャを使用して Python スクリプトを実行するためのサポートが発表されました。将来追加される他の言語も同時に発表されました。

サポートされているバージョンと言語の数が増えているため、データベース管理者とデータベース設計者が、機械学習ジョブに起因するリソースの競合の可能性を認識し、新しいワークロードに対応できるようにサーバーを構成できることが重要です。 データの近くで分析を行うことで、安全ではないデータ移動が無くなりますが、分析のワークロードもまたデータ サイエンティストのラップトップから移動して、データをホストしているサーバーに戻ります。

機械学習のパフォーマンスの最適化は、どんな場合にもうまくいくような提案とはなりません。 次の一般的なタスクでも、パフォーマンス プロファイルが大きく異なるかもしれません。

- トレーニングタスク: 回帰モデルの作成およびトレーニングと、ニューラル ネットワークのトレーニング
- R を使用する特徴量エンジニアリングと、T-SQL を使用する特徴の抽出
- 単一行または小さいバッチでのスコアリングと、表形式の入力を使用する一括スコアリング
- R によるスコアリングの実行と、ストアド プロシージャによる SQL Server 上の運用環境へのモデルの配置
- データ転送を最小限にするために R コードを変更するか、コストのかかるデータ変換を削除するか
- 自動テストの有効化と、モデルの再トレーニング

最適化手法の選択肢は、アプリケーションまたはユース ケースにとって重要なタスクによって異なります。そのため、本ケース スタディでは、一般的なパフォーマンスのヒントと、特定のシナリオに対して最適化する方法 (バッチ スコアリングの最適化) に関するガイダンスの両方について説明します。

+ **SQL Server での個々の最適化オプション**

    最初のパフォーマンス ケース スタディでは、1 種類のモデルを使用して、単一のデータセットに対して複数のテストを実行しました。 RevoscaleR の rxLinMod アルゴリズムを使用してモデルを構築し、そこからスコアを作成しましたが、各変更の影響をテストするためにコードおよび基になるデータ テーブルが意図的に変更されました。

    たとえば、あるテストの実行では、変換関数を使用する特徴量エンジニアリングと、特徴を事前計算した後にテーブルから特徴を読み込む場合の比較を行うことができるように、R コードが変更されました。 別のテストの実行では、標準のインデックス付きテーブルを使用した場合と、さまざまな種類の圧縮または新しい種類のインデックスを持つテーブル内のデータを使用した場合の、モデル トレーニングのパフォーマンスを比較しました。

+ **特定の大規模なスコアリング シナリオの最適化**

    2 番目のケース スタディでの機械学習タスクには、複数の職位に対して提出された多数の履歴書の処理と、それぞれの職位に最適な候補者の検索が含まれます。 機械学習モデル自体は、二項分類の問題として定義されています。これは、履歴書と職務の説明を入力として受け取り、それぞれの履歴書と職務のペアの確率を生成します。 最適な一致を見つけることが目的であるため、ユーザーが定義する確率しきい値を使用して、さらにフィルター処理して適切な一致だけを取得します。

    このソリューションでは、主な目的はスコアリング中の待機時間を短くすることでした。 しかし、このタスクでは、スコアリング プロセスだけでも計算コストが高くなります。妥当な時間内に、新しい職務を一つ一つ、何百万もの履歴書と照合する必要があるためです。 さらに、特徴量エンジニアリングのステップでは履歴書またはジョブごとに 2,000 を超える特徴が生成され、パフォーマンスが大幅に低下します。

最初のケース スタディから得られたすべての結果を確認して、あなたのソリューションに適用できる手法を特定し、潜在的な影響を比較することをお勧めします。

次に、スコアリング最適化のケース スタディの結果を確認して、作成者が特定のワークロードに対応させるために、種々の手法を適用してサーバーを最適化した方法を確認します。

## <a name="performance-optimization-process"></a>パフォーマンスの最適化プロセス

パフォーマンスの構成とチューニングには、特定のワークロード向けに設計された最適化を階層化するためのソリッド ベースを作成する必要があります。

- 分析をホストする適切なサーバーを選択します。 通常は、他のレポートまたは分析目的で既に使用されている、二次的にレポートを行うデータ ウェアハウス、またはその他のサーバーを使用することをお勧めします。 ただし、ハイブリッド トランザクション分析処理 (HTAP) ソリューションでは、オペレーショナル データを R への入力として使用して高速スコアリングを行うことができます。

- SQL Server インスタンスを構成して、データベース エンジンの処理と R または Python スクリプトの実行を、適切なレベルで調整します。 これには、メモリと CPU 使用率、NUMA とプロセッサのアフィニティ設定、およびリソース グループの作成に関する SQL Server の既定値の変更が含まれます。

- サーバー コンピューターを最適化して、外部スクリプトの効率的な使用をサポートします。 これには、外部スクリプトの実行に使用するアカウントの数の増加、パッケージ管理の有効化、および関連するセキュリティ ロールへのユーザーの割り当てが含まれます。

- インデックス作成と統計の方法、クエリのデザインとクエリの最適化、機械学習に使用するテーブルの設計などを含む、データ ストレージに特有の最適化を適用し、SQL Server に転送します。 また、データ ソースとデータ転送方法を分析したり、ETL プロセスを変更して特徴の抽出を最適化したりすることもできます。

- 分析モデルを調整して、非効率性を回避します。 可能な最適化の範囲は、R コードの複雑さと、使用しているパッケージおよびデータによって異なります。 主要なタスクとしては、コストの高いデータ変換の排除や、R または Python から ETL プロセスまたは SQL への、データ準備や特徴量エンジニアリング タスクのオフロードがあります。 また、スクリプトをリファクターし、インライン パッケージのインストールを削除し、R コードをトレーニング、スコアリング、評価のための個別のプロシージャに分割したり、コードを単純化してストアド プロシージャとして効率的に動作させたりすることもできます。

## <a name="articles-in-this-series"></a>このシリーズの記事

+ [SQL Server での R のパフォーマンス チューニング - ハードウェア](../r/sql-server-configuration-r-services.md)

    [!INCLUDE[ssNoVersion_md](../../includes/ssnoversion-md.md)] がインストールされているハードウェアを構成するためのガイダンスと、外部スクリプトをより適切にサポートするように SQL Server インスタンスを構成する方法について説明します。 これは、**データベース管理者**に特に役立ちます。

+ [SQL Server での R のパフォーマンス チューニング - コードとデータの最適化](../r/r-and-data-optimization-r-services.md)

    既知の問題を回避するために外部スクリプトを最適化する方法について、具体的なヒントを提供します。 これは、**データ サイエンティスト**に最も役立ちます。

    > [!NOTE]
    > このセクションの情報の多くは、R 全体に適用されますが、一部の情報は RevoScaleR 分析関数に固有のものです。 **revoscalepy** およびその他のサポートされている Python ライブラリについては、詳細なパフォーマンス ガイダンスを利用できません。
    >

+ [SQL Server での R のパフォーマンス チューニング - 方法と結果](../r/performance-case-study-r-services.md)

    2 つのケース スタディで使用されたデータ、パフォーマンスのテスト方法、および最適化が結果にどのように影響したのかをまとめます。
